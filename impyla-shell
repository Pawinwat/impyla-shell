#!/usr/bin/env python3
import sys
import argparse
from impala.dbapi import connect
import configparser
import os
from prettytable import PrettyTable
import time

def execute_impala_query(query):
    # Get the absolute path to the script's directory
    script_dir = os.path.dirname(os.path.abspath(__file__))

    # Use the absolute path to the new config file
    config_file = os.path.join(script_dir, 'impyla-config.ini')

    # Read connection details from the config file
    config = configparser.ConfigParser()
    config.read(config_file)

    host = config.get('impala', 'host')
    port = config.getint('impala', 'port')
    database = config.get('impala', 'database')
    username = config.get('impala', 'username')
    password = config.get('impala', 'password')

    # Establish a connection to Impala
    conn = connect(host=host, port=port, database=database, user=username, password=password)

    # Create a cursor object to execute queries
    cursor = conn.cursor()

    try:
        start_time = time.time()

        # Execute the provided query
        cursor.execute(query)

        # Fetch the column names
        columns = [desc[0] for desc in cursor.description]

        # Create a PrettyTable with column names
        table = PrettyTable(columns)

        # Fetch and add rows to the table
        rows = cursor.fetchall()
        for row in rows:
            table.add_row(row)

        # Print the table
        print(table)

        end_time = time.time()
        time_used = end_time - start_time
        print(f"\nQuery executed in {time_used:.4f} seconds")

    except Exception as e:
        print("Error executing query:", e)

    finally:
        # Close the cursor and connection
        cursor.close()
        conn.close()

def main():
    parser = argparse.ArgumentParser(description="Execute an Impala query")
    parser.add_argument("-q", "--query", help="Impala query to execute", required=True)
    args = parser.parse_args()

    print("Executing Impala Query:")
    print(args.query)

    execute_impala_query(args.query)

if __name__ == "__main__":
    main()
